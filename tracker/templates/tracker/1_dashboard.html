{% extends "tracker/_base.html" %}
{% load duration_filters %}
{% block content %}
    <h1>Dashboard</h1>

    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div class="card" style="flex: 1; text-align: center;">
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Overall Absenteeism Rate (Predicted)</p>
            <h2 style="color: #dc3545; margin: 0;">{{ overall_absenteeism_rate|default:"0.00%" }}</h2>
            <p style="font-size: 0.8rem; color: #17a2b8;">vs. Last Month: <span style="font-weight: bold;">+0.5%</span></p>
        </div>

        <div class="card" style="flex: 1; text-align: center;">
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Estimated Compensation Reduction</p>
            <h2 style="color: #ffc107; margin: 0;">${{ estimated_compensation_impact|floatformat:2|default:"0.00" }}</h2>
            <p style="font-size: 0.8rem; color: #28a745;">Total Predicted Hours: <span style="font-weight: bold;">{{ total_predicted_hours|default:"0" }}</span></p>
        </div>

        <div class="card" style="flex: 1; text-align: center;">
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Model Prediction Accuracy</p>
            <h2 style="color: #007bff; margin: 0;">{{ model_accuracy|default:"92%" }}</h2>
            <p style="font-size: 0.8rem; color: #6c757d;">(Within $\pm 1$ Hour) | **Fairness Risk: Low**</p>
        </div>
    </div>


    <div style="display: flex; gap: 30px;">
        
        <div style="flex: 3;">
            <h3>Currently Absent Employees</h3>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Reason</th>
                            <th>Pred. Hours</th>
                            <th>Confid.</th>
                            <th>Date Logged</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for absence in current_absences %}
                        <tr>
                            <td>{{ absence.employee.full_name }}</td>
                            <td>{{ absence.reason.description }}</td>
                            <td>{{ absence.predicted_hours|floatformat:1 }} hours</td> 
                            
                            <td>
                                {% if absence.confidence > 0.85 %} 
                                    <span style="color: #28a745; font-weight: bold;">High</span>
                                {% elif absence.confidence > 0.6 %} 
                                    <span style="color: #ffc107; font-weight: bold;">Medium</span>
                                {% else %} 
                                    <span style="color: #dc3545; font-weight: bold;">Low</span>
                                {% endif %}
                            </td>
                            <td>{{ absence.date_logged|date:"M. d, Y" }}</td>
                            
                            <td>
                                {% if absence.status == 'Approved' %} 
                                    <span style="color: #28a745;">&#10004; Approved</span>
                                {% elif absence.status == 'Pending' %}
                                    <span style="color: #dc3545;">&#9888; Review</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center;">No employees are currently absent.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="flex: 2;">
            <h3>Total Hours Lost by Reason (All Time)</h3>
            <div class="card" style="padding: 20px;">
                <canvas id="reasonBarChart"></canvas> 
            </div>
            
            <div class="alert-info" style="margin-top: 15px; font-size: 0.9rem;">
                <p style="margin: 0; font-weight: bold;">Insight:</p>
                <p style="margin: 5px 0 0 0;">'{{ top_reason_label|default:"Medical consultation" }}' is the leading cause of lost time. Consider reviewing health benefits or wellness programs.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const chartLabels = JSON.parse('{{ chart_labels|safe }}'); 
            const chartData = JSON.parse('{{ chart_data|safe }}');   
            
            const ctxBar = document.getElementById('reasonBarChart').getContext('2d');
            
            if (!ctxBar) {
                console.error("Chart.js Error: Could not find canvas element with ID 'reasonBarChart'.");
                return;
            }

            // Function to truncate labels for the Y-axis display
            const truncateLabel = (label, maxLength = 20) => {
                if (label.length > maxLength) {
                    return label.substring(0, maxLength) + '...';
                }
                return label;
            };

            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Total Hours Lost',
                        data: chartData,
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Absent Hours',
                                font: { size: 14 }
                            },
                            ticks: { font: { size: 12 } }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Absence Reason',
                                font: { size: 14 }
                            },
                            ticks: {
                                font: { size: 12 },
                                autoSkip: false, 
                                maxRotation: 0,
                                minRotation: 0,
                                
                                // Truncate the label displayed on the Y-axis
                                callback: function(value, index, values) {
                                    return truncateLabel(this.getLabelForValue(value));
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                // Display the full, original label in the tooltip title
                                title: function(context) {
                                    return context[0].label;
                                },
                                // Keep the data label clean
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += context.parsed.x + ' hours';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: { left: 10, right: 10, top: 10, bottom: 10 }
                    }
                }
            });
        });
    </script>
{% endblock %}