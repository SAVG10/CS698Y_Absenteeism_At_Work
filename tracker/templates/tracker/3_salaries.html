{% extends "tracker/_base.html" %}
{% load duration_filters %}
{% block content %}
    <h1>Expected Monthly Compensation</h1>
    <p>
        This report forecasts employee compensation for the current month. It assumes a standard 160-hour work month with \$30 compensation per hour and subtracts any 
        <strong>predicted absence hours</strong> logged this month.
    </p>

    <!-- Summary Widgets -->
    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="card" style="flex: 1; text-align: center;">
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Total Predicted Hours Lost (Company)</p>
            <h2 style="color: #dc3545; margin: 0;">{{ overall_company_hours_lost|default:"0.0" }} Hours</h2>
        </div>

        <div class="card" style="flex: 1; text-align: center;">
            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Total Estimated Absence Cost (Company)</p>
            <h2 style="color: #ffc107; margin: 0;">${{ overall_company_cost_impact|floatformat:2|default:"0.00" }}</h2>
        </div>
    </div>
    
    <!-- Filtering and Scalability Section -->
    <div class="card" style="margin-bottom: 20px; padding: 15px;">
        <form id="salary-filter-form" method="GET" style="display: flex; gap: 20px; align-items: flex-end;">
            <div class="form-group" style="flex: 2; margin-bottom: 0;">
                <label for="employee_search">Filter by Employee Name/ID</label>
                <input type="text" id="employee_search" name="search" value="{{ search|default:'' }}" placeholder="Start typing name or ID..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
            </div>
            
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="severity_filter">Filter by Absence Severity</label>
                <select id="severity_filter" name="severity" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    <option value="" {% if not severity %}selected{% endif %}>All Absences</option>
                    <option value="low" {% if severity == 'low' %}selected{% endif %}>Low Impact (0 - 4h)</option>
                    <option value="medium" {% if severity == 'medium' %}selected{% endif %}>Medium Risk (4.1 - 8h)</option>
                    <option value="high" {% if severity == 'high' %}selected{% endif %}>High Risk (> 8h)</option>
                </select>
            </div>
            
            <button type="submit" class="btn" style="flex: 0; padding: 8px 15px; font-size: 1rem;">Apply Filters</button>
            <a href="{% url 'salaries' %}" class="btn" style="background-color: #6c757d; color: white; text-decoration: none; flex: 0; padding: 8px 15px; font-size: 1rem;">Clear</a>
        </form>
    </div>
    <!-- End Filtering Section -->

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Employee Id</th>
                    <th>Predicted Hours Lost</th>
                    <th>Expected Work Hours</th>
                    <th>Estimated Absence Cost</th> 
                    <th>Expected Compensation</th>
                </tr>
            </thead>
            <tbody>
                {% for item in salary_data %}
                {% with hours=item.total_absent_hours %}
                
                {# Initialize the row_style variable outside the if block #}
                {% if hours > 10.0 %}
                    {# Light Red for > 10 hours (High Risk) #}
                    {% with row_style='background-color: #f8d7da; border-left: 3px solid #dc3545;' %}
                    {% endwith %}
                {% elif hours > 0.0 %}
                    {# Yellow for 0 < hours <= 10 hours #}
                    {% with row_style='background-color: #fff3cd; border-left: 3px solid #ffc107;' %}
                    {% endwith %}
                {% else %}
                    {# Default for 0 hours #}
                    {% with row_style='' %}
                    {% endwith %}
                {% endif %}
                
                <tr style="{{ row_style }}">
                    <td>{{ item.employee_id }}</td>
                    <td>{{ hours|floatformat:1 }} hours</td> 
                    <td>{{ item.expected_work_hours|floatformat:1 }}</td>
                    <td style="font-weight: bold; color: #dc3545;">
                        ${{ item.absence_cost|floatformat:2|default:"0.00" }}
                    </td> 
                    <td><b>${{ item.expected_compensation|floatformat:2 }}</b></td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
            
            <tfoot>
                <tr style="background-color: #f1f3f5; font-weight: bold;">
                    <td>TOTALS:</td>
                    <td>{{ total_company_hours_lost|floatformat:1 }} hours</td>
                    <td>-</td>
                    <td>${{ total_company_cost_impact|floatformat:2|default:"0.00" }}</td>
                    <td>-</td>
                </tr>
            </tfoot>
        </table>
    </div>
{% endblock %}